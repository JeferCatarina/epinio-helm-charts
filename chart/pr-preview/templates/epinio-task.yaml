apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: {{ .Release.Name }}-epinio-push
  labels:
    {{- range $key, $value := .Values.labels }}
    {{ $key }}: {{ $value | quote }} 
    {{- end }}
    {{- include "pr-preview.labels" . | nindent 4 }}
spec:
  description: Read and display README file.
  workspaces:
    - name: source
  params:
    - name: pr-number
      type: string
  steps:
    - computeResources: {}
      image: harbor.stack.io/apps/epinio-tekton:v1.11.0
      volumeMounts:
      - name: epinio-auth
        mountPath: /var/secret
      env:
      - name: EPINIO_PASSWORD
        valueFrom: 
          secretKeyRef:
            key: password
            name: epinio-auth
      name: epinio
      script: |
        #!/usr/bin/env sh

        epinio login https://epinio.epinio.demo.stack.io --user admin --password $(cat /var/secret/password) && \
        epinio target {{ .Release.Namespace }} && \
        epinio push --path=$(workspaces.source.path) --name {{ .Values.epinio.serviceName }}-pr-$(params.pr-number)
